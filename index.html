<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom styles for the Inter font and basic body styling */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ul::-webkit-scrollbar {
            width: 8px;
        }
        ul::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ul::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ul::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-700 to-indigo-900 flex items-center justify-center p-4">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-3xl w-full max-w-md transform transition-all duration-300 hover:scale-[1.005]">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center tracking-tight">
            <i class="fas fa-clipboard-list text-indigo-600 mr-3"></i> My Awesome To-Do List
        </h1>

        <form id="todo-form" class="flex flex-col sm:flex-row gap-3 mb-6">
            <input
                type="text"
                id="new-todo-input"
                placeholder="What needs to be done?"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-3 focus:ring-indigo-500 focus:border-transparent text-gray-700 placeholder-gray-400 text-lg transition duration-200 ease-in-out"
            />
            <button
                type="submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5 hover:shadow-xl flex items-center justify-center gap-2"
            >
                <i class="fas fa-plus-circle"></i> Add Task
            </button>
        </form>

        <div id="todos-container">
            <p id="no-tasks-message" class="text-center text-gray-500 text-lg py-8 bg-gray-100 rounded-lg border border-dashed border-gray-300">
                <i class="far fa-smile-beam text-4xl mb-3 text-indigo-400"></i><br/>
                No tasks yet! Time to add some.
            </p>
            <ul id="todo-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                </ul>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const todoForm = document.getElementById('todo-form');
        const newTodoInput = document.getElementById('new-todo-input');
        const todoList = document.getElementById('todo-list');
        const noTasksMessage = document.getElementById('no-tasks-message');

        // Initialize todos array from local storage or as an empty array
        let todos = JSON.parse(localStorage.getItem('todos')) || [];

        // API key for Gemini API (IMPORTANT: Replace "YOUR_GEMINI_API_KEY_HERE" with your actual key)
        const API_KEY = "AIzaSyC8b--W_ROPNfBiMX2jKV-a9RWBSW_RdYI"; // <--- Insert your Gemini API key here
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        /**
         * Saves the current todos array to local storage.
         */
        function saveTodos() {
            try {
                localStorage.setItem('todos', JSON.stringify(todos));
            } catch (error) {
                console.error("Failed to save todos to local storage:", error);
            }
        }

        /**
         * Displays a temporary message to the user (e.g., for loading or errors).
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info' to style the message.
         * @param {HTMLElement} targetElement - The element to append the message to.
         */
        function showTemporaryMessage(message, type, targetElement) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg text-sm text-center mt-2 ${
                type === 'success' ? 'bg-green-100 text-green-700' :
                type === 'error' ? 'bg-red-100 text-red-700' :
                'bg-blue-100 text-blue-700'
            }`;
            messageDiv.textContent = message;
            targetElement.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000); // Message disappears after 3 seconds
        }

        /**
         * Renders the list of todos to the DOM.
         * Clears existing list items and recreates them based on the `todos` array.
         */
        function renderTodos() {
            todoList.innerHTML = ''; // Clear existing list items

            if (todos.length === 0) {
                noTasksMessage.classList.remove('hidden'); // Show "No tasks" message
            } else {
                noTasksMessage.classList.add('hidden'); // Hide "No tasks" message
                todos.forEach(todo => {
                    // Create list item element
                    const listItem = document.createElement('li');
                    // Add a class for suggested tasks for distinct styling
                    listItem.className = `flex items-center justify-between bg-white p-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01] border-l-4 ${
                        todo.completed ? 'border-green-500' : (todo.isSuggested ? 'border-blue-400' : 'border-indigo-400')
                    }`;
                    listItem.dataset.id = todo.id; // Store todo ID for easy access

                    // Create div for checkbox and text
                    const textContainer = document.createElement('div');
                    textContainer.className = 'flex items-center flex-grow';

                    // Create checkbox input
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = todo.completed;
                    checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 rounded-md focus:ring-indigo-500 cursor-pointer transition duration-150 ease-in-out';
                    checkbox.addEventListener('change', () => toggleComplete(todo.id));

                    // Create span for todo text
                    const todoText = document.createElement('span');
                    todoText.className = `ml-3 text-lg text-gray-800 ${todo.completed ? 'line-through text-gray-500 italic' : ''} transition duration-150 ease-in-out`;
                    todoText.textContent = todo.text;

                    // Append checkbox and text to their container
                    textContainer.appendChild(checkbox);
                    textContainer.appendChild(todoText);

                    // Create actions container for buttons
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'flex items-center space-x-2';

                    // Create "Brainstorm Related Tasks" button (New Gemini API integration)
                    const brainstormButton = document.createElement('button');
                    brainstormButton.className = 'p-2 text-orange-600 hover:text-orange-800 transition duration-200 ease-in-out rounded-full hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-300';
                    brainstormButton.setAttribute('aria-label', 'Brainstorm related tasks');
                    brainstormButton.innerHTML = '<i class="fas fa-lightbulb"></i>'; // Lightbulb icon
                    brainstormButton.title = 'Brainstorm related tasks ✨';
                    brainstormButton.addEventListener('click', () => brainstormRelatedTasks(todo.id, todo.text, listItem));


                    // Create "Break Down" button (Gemini API integration)
                    const breakDownButton = document.createElement('button');
                    breakDownButton.className = 'p-2 text-purple-600 hover:text-purple-800 transition duration-200 ease-in-out rounded-full hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-purple-300';
                    breakDownButton.setAttribute('aria-label', 'Break down task');
                    breakDownButton.innerHTML = '<i class="fas fa-magic"></i>'; // Magic wand icon
                    breakDownButton.title = 'Break down this task ✨';
                    breakDownButton.addEventListener('click', () => breakDownTask(todo.id, todo.text, listItem));

                    // Create delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'p-2 text-red-500 hover:text-red-700 transition duration-200 ease-in-out rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-300';
                    deleteButton.setAttribute('aria-label', 'Delete todo');
                    deleteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    `;
                    deleteButton.addEventListener('click', () => deleteTodo(todo.id));

                    // Append buttons to actions container (order matters)
                    actionsContainer.appendChild(brainstormButton);
                    actionsContainer.appendChild(breakDownButton);
                    actionsContainer.appendChild(deleteButton);

                    // Append all parts to the list item
                    listItem.appendChild(textContainer);
                    listItem.appendChild(actionsContainer);

                    // Append the list item to the todo list
                    todoList.appendChild(listItem);
                });
            }
        }

        /**
         * Handles adding a new todo item when the form is submitted.
         * @param {Event} e - The submit event object.
         */
        function addTodo(e) {
            e.preventDefault(); // Prevent default form submission
            const text = newTodoInput.value.trim();
            if (text !== '') {
                todos.push({ id: Date.now(), text: text, completed: false, isSuggested: false });
                newTodoInput.value = ''; // Clear the input field
                saveTodos();
                renderTodos();
            }
        }

        /**
         * Toggles the completion status of a todo item.
         * @param {number} id - The ID of the todo item to toggle.
         */
        function toggleComplete(id) {
            todos = todos.map(todo =>
                todo.id === id ? { ...todo, completed: !todo.completed } : todo
            );
            saveTodos();
            renderTodos();
        }

        /**
         * Deletes a todo item from the list.
         * @param {number} id - The ID of the todo item to delete.
         */
        function deleteTodo(id) {
            todos = todos.filter(todo => todo.id !== id);
            saveTodos();
            renderTodos();
        }

        /**
         * Calls the Gemini API to break down a given task into sub-tasks.
         * @param {number} taskId - The ID of the task being broken down.
         * @param {string} taskText - The text of the task to break down.
         * @param {HTMLElement} listItemElement - The DOM element of the list item to show loading/messages.
         */
        async function breakDownTask(taskId, taskText, listItemElement) {
            const buttonElement = listItemElement.querySelector('.fa-magic').parentNode;
            const originalButtonContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner animate-spin"></i>';
            buttonElement.disabled = true;

            try {
                const prompt = `Break down the following task into 3-5 actionable sub-tasks. Provide each sub-task on a new line, starting with a hyphen. Do not include any introductory or concluding sentences, just the list. Task: '${taskText}'`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    const subTasks = generatedText.split('\n')
                                                .map(line => line.trim())
                                                .filter(line => line.startsWith('- ') && line.length > 2)
                                                .map(line => line.substring(2).trim()); // Remove hyphen and space

                    if (subTasks.length > 0) {
                        const newTodos = subTasks.map(text => ({
                            id: Date.now() + Math.random(), // Ensure unique ID
                            text: text,
                            completed: false,
                            isSuggested: true // Mark as suggested
                        }));
                        todos = [...todos, ...newTodos]; // Add new tasks to the list
                        saveTodos();
                        renderTodos();
                        showTemporaryMessage('Task broken down successfully! ✨', 'success', todoList.parentNode);
                    } else {
                        showTemporaryMessage('Could not break down task into sub-tasks. Please try a different task or rephrase.', 'info', todoList.parentNode);
                    }
                } else {
                    showTemporaryMessage('Failed to get a valid response from the AI. Please try again.', 'error', todoList.parentNode);
                }
            } catch (error) {
                console.error("Error breaking down task:", error);
                showTemporaryMessage('An error occurred while contacting the AI. Please check your network.', 'error', todoList.parentNode);
            } finally {
                // Restore button state
                buttonElement.innerHTML = originalButtonContent;
                buttonElement.disabled = false;
            }
        }

        /**
         * Calls the Gemini API to brainstorm related tasks for a given task.
         * @param {number} taskId - The ID of the task for which to brainstorm.
         * @param {string} taskText - The text of the task to brainstorm from.
         * @param {HTMLElement} listItemElement - The DOM element of the list item to show loading/messages.
         */
        async function brainstormRelatedTasks(taskId, taskText, listItemElement) {
            const buttonElement = listItemElement.querySelector('.fa-lightbulb').parentNode;
            const originalButtonContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner animate-spin"></i>';
            buttonElement.disabled = true;

            try {
                const prompt = `Brainstorm 2-3 related tasks for the following main task. Provide each related task on a new line, starting with a hyphen. Do not include any introductory or concluding sentences, just the list. Main Task: '${taskText}'`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    const relatedTasks = generatedText.split('\n')
                                                .map(line => line.trim())
                                                .filter(line => line.startsWith('- ') && line.length > 2)
                                                .map(line => line.substring(2).trim()); // Remove hyphen and space

                    if (relatedTasks.length > 0) {
                        const newTodos = relatedTasks.map(text => ({
                            id: Date.now() + Math.random(), // Ensure unique ID
                            text: text,
                            completed: false,
                            isSuggested: true // Mark as suggested
                        }));
                        todos = [...todos, ...newTodos]; // Add new tasks to the list
                        saveTodos();
                        renderTodos();
                        showTemporaryMessage('Related tasks brainstormed successfully! ✨', 'success', todoList.parentNode);
                    } else {
                        showTemporaryMessage('Could not brainstorm related tasks. Please try a different task or rephrase.', 'info', todoList.parentNode);
                    }
                } else {
                    showTemporaryMessage('Failed to get a valid response from the AI. Please try again.', 'error', todoList.parentNode);
                }
            } catch (error) {
                console.error("Error brainstorming related tasks:", error);
                showTemporaryMessage('An error occurred while contacting the AI. Please check your network.', 'error', todoList.parentNode);
            } finally {
                // Restore button state
                buttonElement.innerHTML = originalButtonContent;
                buttonElement.disabled = false;
            }
        }

        // Event listener for form submission (add todo)
        todoForm.addEventListener('submit', addTodo);

        // Initial render of todos when the page loads
        document.addEventListener('DOMContentLoaded', renderTodos);
    </script>
</body>
</html>
